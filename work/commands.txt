https://aka.ms/azpipelines-parallelism-request



Remove machine specific information by deprovisioning or generalizing a VM before creating an image
Article
04/14/2023
6 contributors
In this article
Linux
Windows
Next steps
Generalizing or deprovisioning a VM is not necessary for creating an image in an Azure Compute Gallery unless you specifically want to create an image that has no machine specific information, like user accounts. Generalizing is still required when creating a managed image outside of a gallery.

Generalizing removes machine specific information so the image can be used to create multiple VMs. Once the VM has been generalized or deprovisioned, you need to let the platform know so that the boot sequence can be set correctly.

 Important

Once you mark a VM as generalized in Azure, you cannot restart the VM.

Linux
Distribution specific instructions for preparing Linux images for Azure are available here:

Generic steps
CentOS
Debian
Flatcar
FreeBSD
Oracle Linux
OpenBSD
Red Hat
SUSE
Ubuntu
The following instructions only cover setting the VM to generalized. We recommend you follow the distro specific instructions for production workloads.

First you'll deprovision the VM by using the Azure VM agent to delete machine-specific files and data. Use the waagent command with the -deprovision+user parameter on your source Linux VM. For more information, see the Azure Linux Agent user guide. This process can't be reversed.

Connect to your Linux VM with an SSH client.

In the SSH window, enter the following command:

Bash

Copy
 sudo waagent -deprovision+user
 Note

Only run this command on a VM that you'll capture as an image. This command does not guarantee that the image is cleared of all sensitive information or is suitable for redistribution. The +user parameter also removes the last provisioned user account. To keep user account credentials in the VM, use only -deprovision.

Enter y to continue. You can add the -force parameter to avoid this confirmation step.

After the command completes, enter exit to close the SSH client. The VM will still be running at this point.

Deallocate the VM that you deprovisioned with az vm deallocate so that it can be generalized.

Azure CLI

Copy

Open Cloudshell
az vm deallocate --resource-group shubh-resources --name shubh-vm
Then the VM needs to be marked as generalized on the platform.

Azure CLI

Copy

Open Cloudshell
az vm generalize --resource-group shubh-resources --name shubh-vm


now create image using this command,
az image create --resource-group shubh-resources --name terra-image --source shubh-vm